# 动态库内存分配的理解

- 针对实际应用场景，进行dll中静态变量内存的分析。
    - USB通讯动态链接库中，设备句柄被配置为static变量。多开启多线程，那么Handle是指向多个设备？还是仅仅一个设备？



## 搜索资料

- 动态库在被系统加载后，代码段只有一份，所有使用者共享。对于数据段要分两种情况：
    - 如果是**多进程**的话，数据段在每个进程中拥有一个独立的副本，所以数据是安全的。
    - 如果是**多线程**的话，数据段在同一个进程中是同一个地址空间，所以数据是不安全的。
        - 线程之间共享（进程所有）
            1. 全局变量
            2. 堆
            3. 函数里的静态变量
            4. 程序代码（任何线程都有权力读取和执行）
            5. 打开的文件（A线程打开，B线程可以直接读写）
        - 线程私有 （特点：栈空间）
            1. 局部变量
            2. 函数参数

- 共享数据段
    - 共享数据段可以解决多个进程希望通过一个动态库里的某个全局变量来实现进程间通信的问题。



## 实测

经过这段代码的测试，发现s_num通过多线程调用相关的接口，则都可以修改，且内存唯一。而多个进程去运行读取s_num，则相互之间没有关联。



## 小结

因为之前学习过RTOS，发现这里的进程和线程的内存占用情况和main中的多任务有一定的类似。各个task之间栈空间都是独立的，但是如果有全局的变量或者缓存，则各个任务都可以调用，且都是同一块地址。

